C51 COMPILER V9.54   DS1302                                                                09/05/2022 21:27:49 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\DS1302.obj
COMPILER INVOKED BY: D:\keil_v5\C51\BIN\C51.EXE DS1302.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\DS
                    -1302.lst) OBJECT(.\Objects\DS1302.obj)

line level    source

   1          #include <REGX52.H>
   2          
   3          //åˆ©ç”¨å®å°†DS1302æ—¶é—´ä¿¡æ¯å®šä¹‰
   4          #define DS1302_SECOND           0x80
   5          #define DS1302_MINUTE           0x82
   6          #define DS1302_HOUR                     0x84
   7          #define DS1302_DATE                     0x86
   8          #define DS1302_MONTH            0x88
   9          #define DS1302_DAY                      0x8A
  10          #define DS1302_YEAR                     0x8C
  11          #define DS1302_WP                       0x8E
  12          
  13          //å®šä¹‰DS1302ä¸MCUé€šè®¯çš„ä¸‰ä¸ªå¼•è„š
  14          sbit DS1302_SCLK = P3^6;
  15          sbit DS1302_IO = P3^4;
  16          sbit DS1302_CE = P3^5;
  17          
  18          //å®šä¹‰æ—¶é—´æ•°ç»„ï¼š[year, month, date, hour, min, sec, day]
  19          char DS1302_Time[] = {22, 9, 4, 21, 31, 1};
  20          //æœ‰ç¬¦å·æ•°èŒƒå›´ï¼š-128~+127
  21          
  22          /**
  23            * @brief      DS1302åˆå§‹åŒ–
  24            * @param      æ— 
  25            * @retval     æ— 
  26            * å› ä¸ºå•å“æœºå¼•è„šä¸Šç”µé»˜è®¤ä¸º1ï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨ç½®0
  27            */
  28          void DS1302_Init(void)
  29          {
  30   1              DS1302_CE = 0;
  31   1              DS1302_SCLK = 0;
  32   1      }
  33          
  34          /**
  35            * @brief      DS1302å†™å…¥ä¸€ä¸ªå­—èŠ‚
  36            * @param      command         å‘½ä»¤å­—ï¼Œå³å†™å…¥å¯„å­˜å™¨çš„ç‰©ç†åœ°å€
  37            * @param      writeData       å†™å…¥çš„å­—èŠ‚
  38            * @retval     æ— 
  39            * DS1302å†™å…¥æ•°æ®çš„é¡ºåºï¼šå†™å…¥å‘½ä»¤å­— â€”â€”> å†™å…¥ç›¸åº”çš„æ•°æ®
  40            */
  41          void DS1302_WriteByte(unsigned char command, writeData)
  42          {
  43   1              unsigned int i;
  44   1              
  45   1              //CEç½®1ï¼Œå†™å…¥å¼€å§‹
  46   1              DS1302_CE = 1;
  47   1              
  48   1              //å†™å…¥å‘½ä»¤å­—
  49   1              for (i = 0; i < 8; i ++)
  50   1              {
  51   2                      DS1302_IO = command & (0x01 << i);      //å–å‡ºå‘½ä»¤çš„ç¬¬0ä½ã€ç¬¬1ä½â€¦â€¦ã€ç¬¬7ä½
  52   2                      DS1302_SCLK = 1;
  53   2                      DS1302_SCLK = 0;
  54   2              }
C51 COMPILER V9.54   DS1302                                                                09/05/2022 21:27:49 PAGE 2   

  55   1              
  56   1              //å†™å…¥æ•°æ®
  57   1              for (i = 0; i < 8; i ++)
  58   1              {
  59   2                      DS1302_IO = writeData & (0x01 << i);    //å–å‡ºå‘½ä»¤çš„ç¬¬0ä½ã€ç¬¬1ä½â€¦â€¦ã€ç¬¬7ä½
  60   2                      DS1302_SCLK = 1;
  61   2                      DS1302_SCLK = 0;
  62   2              }
  63   1              
  64   1              //CEç½®0ï¼Œå†™å…¥ç»“æŸ
  65   1              DS1302_CE = 0;
  66   1      }
  67          
  68          /**
  69            * @brief      DS1302è¯»å–ä¸€ä¸ªå­—èŠ‚
  70            * @param      command         å‘½ä»¤å­—ï¼Œå³è¯»å–å¯„å­˜å™¨çš„ç‰©ç†åœ°å€
  71            * @retval     readData        è¯»å–çš„æ•°æ®(1B)
  72            * DS1302è¯»å–æ•°æ®çš„é¡ºåºï¼šå†™å…¥å‘½ä»¤å­— â€”â€”> è¯»å–ç›¸åº”çš„æ•°æ®
  73            */
  74          unsigned char DS1302_ReadByte(unsigned char command)
  75          {
  76   1              unsigned char i, readData = 0x00;
  77   1              
  78   1              //è¯»å–çš„å‘½ä»¤å­—æ¯”å†™å…¥çš„å‘½ä»¤å­—æœ€ä½ä½å¤š1(ç›¸åŒåœ°å€)
  79   1              //æ­¤ä¸¾å¤§å¹…å‡å°‘å®šä¹‰è¯»å–åœ°å€çš„éº»çƒ¦
  80   1              command |= 0x01;
  81   1              
  82   1              //CEç½®1ï¼Œå†™å…¥å¼€å§‹
  83   1              DS1302_CE = 1;
  84   1              
  85   1              //å†™å…¥å‘½ä»¤å­—
  86   1              for (i = 0; i < 8; i ++)
  87   1              {
  88   2                      DS1302_IO = command & (0x01 << i);      //å–å‡ºå‘½ä»¤çš„ç¬¬0ä½ã€ç¬¬1ä½â€¦â€¦ã€ç¬¬7ä½
  89   2                      DS1302_SCLK = 0;
  90   2                      DS1302_SCLK = 1;
  91   2                      //æ³¨æ„æ­¤å¤„SCLKä¸Šå‡æ²¿ä¸ä¸‹é™æ²¿çš„é¡ºåº
  92   2                      //åŸå› ï¼šè¯»å–æ•°æ®çš„SCLKä¸€å…±æœ‰15ä¸ªè„‰å†²ï¼Œä¸å†™å…¥æ•°æ®çš„16ä¸ªè„‰å†²å¹¶ä¸ç›¸åŒ
  93   2                      //å› ä¸ºè¯»å–æ•°æ®çš„SCLKåœ¨å†™å…¥å‘½ä»¤å­—ç»“æŸçš„ä¸‹é™æ²¿å°±ç«‹åˆ»è¯»å‡ºæ•°æ®
  94   2                      //è€Œå†™å…¥æ•°æ®çš„SCLKçš„å†™å…¥å‘½ä»¤å­—ä¸å†™å…¥æ•°æ®éƒ½æ˜¯ä¾é ä¸Šå‡æ²¿
  95   2                      //è¯¥å¤„å¾ªç¯ç»“æŸï¼Œåœæ­¢åœ¨å†™å…¥å‘½ä»¤å­—çš„ä¸Šå‡æ²¿
  96   2              }
  97   1              
  98   1              //è¯»å–æ•°æ®
  99   1              for (i = 0; i < 8; i ++)
 100   1              {
 101   2                      DS1302_SCLK = 1;
 102   2                      DS1302_SCLK = 0;
 103   2                      if (DS1302_IO)
 104   2                              readData |= (0x01 << i);
 105   2              }
 106   1              
 107   1              //CEç½®0ï¼Œè¯»å–ç»“æŸ
 108   1              DS1302_CE = 0;
 109   1              
 110   1              //è¯»å–ç»“æŸï¼Œæ¸…ç©ºIO
 111   1              DS1302_IO = 0;
 112   1              
 113   1              return readData;
 114   1      }
 115          
 116          /**
C51 COMPILER V9.54   DS1302                                                                09/05/2022 21:27:49 PAGE 3   

 117            * @brief      è®¾ç½®DS1302çš„è®¡æ—¶æ—¶é—´
 118            * @param      æ— 
 119            * @retval     æ— 
 120            */
 121          void DS1302_SetTime(void)
 122          {
 123   1              DS1302_WriteByte(DS1302_WP, 0x00);      //å…³é—­å†™ä¿æŠ¤
 124   1              DS1302_WriteByte(DS1302_YEAR, DS1302_Time[0]/10*16+DS1302_Time[0]%10);  //å†™å…¥ï¼Œå°†åè¿›åˆ¶æ•°æ®è½¬å
             -Œ–ä¸ºBCDç 
 125   1              DS1302_WriteByte(DS1302_MONTH, DS1302_Time[1]/10*16+DS1302_Time[1]%10);
 126   1              DS1302_WriteByte(DS1302_DATE, DS1302_Time[2]/10*16+DS1302_Time[2]%10);
 127   1              DS1302_WriteByte(DS1302_HOUR, DS1302_Time[3]/10*16+DS1302_Time[3]%10);
 128   1              DS1302_WriteByte(DS1302_MINUTE, DS1302_Time[4]/10*16+DS1302_Time[4]%10);
 129   1              DS1302_WriteByte(DS1302_SECOND, DS1302_Time[5]/10*16+DS1302_Time[5]%10);
 130   1              DS1302_WriteByte(DS1302_DAY, DS1302_Time[6]/10*16+DS1302_Time[6]%10);
 131   1              DS1302_WriteByte(DS1302_WP, 0x00);      //æ‰“å¼€å†™ä¿æŠ¤
 132   1      }
 133          
 134          /**
 135            * @brief      è¯»å–DS1302æ—¶é—´
 136            * @param      æ— 
 137            * @retval     æ— 
 138            */
 139          void DS1302_ReadTime(void)
 140          {
 141   1              unsigned char temp;
 142   1              temp = DS1302_ReadByte(DS1302_YEAR);
 143   1              DS1302_Time[0] = temp/16*10 + temp%16;          //è¯»å–ï¼Œå°†BCDç è½¬åŒ–ä¸ºåè¿›åˆ¶æ•°æ®
 144   1              temp = DS1302_ReadByte(DS1302_MONTH);
 145   1              DS1302_Time[1] = temp/16*10 + temp%16;
 146   1              temp = DS1302_ReadByte(DS1302_DATE);
 147   1              DS1302_Time[2] = temp/16*10 + temp%16;
 148   1              temp = DS1302_ReadByte(DS1302_HOUR);
 149   1              DS1302_Time[3] = temp/16*10 + temp%16;
 150   1              temp = DS1302_ReadByte(DS1302_MINUTE);
 151   1              DS1302_Time[4] = temp/16*10 + temp%16;
 152   1              temp = DS1302_ReadByte(DS1302_SECOND);
 153   1              DS1302_Time[5] = temp/16*10 + temp%16;
 154   1              temp = DS1302_ReadByte(DS1302_DAY);
 155   1              DS1302_Time[6] = temp/16*10 + temp%16;
 156   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    711    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
